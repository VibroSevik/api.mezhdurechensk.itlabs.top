{# templates/admin/map_point_form.html.twig #}
{% extends '@EasyAdmin/crud/new.html.twig' %}

{% block head_stylesheets %}
    {{ parent() }}
    <style>
        .custom-map-container {
            margin: 20px 0;
            position: relative;
            overflow: hidden;
            width: 100%;
            height: 500px;
        }
        .custom-map-img {
            position: absolute;
            max-width: none;
            transform-origin: 0 0;
            transition: transform 0.1s;
        }

        .map-marker {
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
        }

        .existing-marker {
            background-color: #4285F4;
            border: 2px solid white;
        }

        .new-marker {
            background-color: #EA4335;
            animation: pulse 1.5s infinite;
        }

        .map-tooltip {
            position: absolute;
            bottom: calc(100% + 5px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .map-marker:hover .map-tooltip {
            opacity: 1;
        }

        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
    </style>
{% endblock %}

{% block body_javascript %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const mapContainer = document.querySelector('.custom-map-container');
            const mapImg = document.querySelector('.custom-map-img');
            const xInput = document.querySelector('#MapObject_x');
            const yInput = document.querySelector('#MapObject_y');
            let newMarker = null;

            // Начальные параметры
            let scale = 1;
            const minScale = 0.5;
            const maxScale = 3;
            const scaleStep = 0.1;

            // Позиционируем маркеры существующих точек
            document.querySelectorAll('.existing-marker').forEach(marker => {
                marker.style.transform = `translate(-50%, -50%) scale(${1/scale})`;
            });

            // Обработчик колесика мыши
            mapContainer.addEventListener('wheel', function(e) {
                e.preventDefault();

                // Получаем позицию курсора относительно изображения
                const rect = mapImg.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;

                // Вычисляем позицию в координатах оригинального изображения
                const imgX = mouseX / scale;
                const imgY = mouseY / scale;

                // Изменяем масштаб
                const delta = -Math.sign(e.deltaY);
                const newScale = Math.max(minScale, Math.min(maxScale, scale + delta * scaleStep));

                // Применяем трансформацию
                mapImg.style.transform = `scale(${newScale})`;

                // Корректируем позицию чтобы zoom был к курсору
                const newMouseX = imgX * newScale;
                const newMouseY = imgY * newScale;
                mapImg.style.left = `${parseFloat(mapImg.style.left || 0) + (mouseX - newMouseX)}px`;
                mapImg.style.top = `${parseFloat(mapImg.style.top || 0) + (mouseY - newMouseY)}px`;

                scale = newScale;

                // Масштабируем маркеры
                document.querySelectorAll('.map-marker').forEach(marker => {
                    marker.style.transform = `translate(-50%, -50%) scale(${1/scale})`;
                });
            });

            // Обработчик клика (с учетом масштаба)
            mapImg.addEventListener('click', function(e) {
                const rect = mapImg.getBoundingClientRect();

                // Вычисляем позицию с учетом масштаба и смещения
                const x = (e.clientX - rect.left - parseFloat(mapImg.style.left || 0)) / scale;
                const y = (e.clientY - rect.top - parseFloat(mapImg.style.top || 0)) / scale;

                if (newMarker) {
                    newMarker.remove();
                }

                newMarker = document.createElement('div');
                newMarker.className = 'map-marker new-marker';
                newMarker.style.left = x + 'px';
                newMarker.style.top = y + 'px';
                newMarker.style.transform = `translate(-50%, -50%) scale(${1/scale})`;
                mapContainer.appendChild(newMarker);

                xInput.value = x;
                yInput.value = y;
            });
        });
    </script>
{% endblock %}

{% block main %}
    {{ parent() }}

    <div class="custom-map-container">
        <img src="{{ asset('images/map.png') }}" class="custom-map-img" alt="Custom Map">

        {% for point in app.request.get('all_points') ?? [] %}
            <div class="map-marker existing-marker"
                 style="left: {{ point.x }}px; top: {{ point.y }}px;">
                <div class="map-tooltip">{{ point.name }}</div>
            </div>
        {% endfor %}
    </div>
{% endblock %}